<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Name Slot Machine</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --text:#2e2e2e;
      --muted:#6b7280;

      --card:#ffffff;
      --card2:#f8fafc;
      --border:#d7dce3;

      --btn:#ffffff;
      --btnBorder:#c9ced6;

      --shadow: 0 10px 24px rgba(0,0,0,0.10);

      --danger:#ff3b30;
      --outline:#bdbdbd;

      --tabActive: rgba(0,0,0,0.06);
      --menuHover: rgba(0,0,0,0.06);

      --accent: rgba(0,0,0,0.10);

      --toastBg: rgba(0,0,0,0.75);
      --toastText: #ffffff;
    }

    [data-theme="dark"]{
      --bg:#000000;
      --text:#f2f2f2;
      --muted:#a6a6a6;

      --card:#0b0b0b;
      --card2:#111111;
      --border:#242424;

      --btn:#0b0b0b;
      --btnBorder:#2a2a2a;

      --shadow: 0 10px 24px rgba(0,0,0,0.55);

      --danger:#ff5a52;
      --outline:#3a3a3a;

      --tabActive: rgba(255,255,255,0.10);
      --menuHover: rgba(255,255,255,0.10);

      --accent: rgba(255,255,255,0.14);

      --toastBg: rgba(255,255,255,0.14);
      --toastText: #ffffff;
    }

    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    header{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 10;
    }
    h1{ font-size: 18px; margin: 0 0 4px; }
    .muted{ color: var(--muted); font-size: 13px; }

    main{ padding: 14px 14px 88px; max-width: 980px; margin: 0 auto; }

    .panel{ display:none; }
    .panel.active{ display:block; }

    .card{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: var(--card);
    }

    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    input[type="text"]{
      flex: 1;
      min-width: 180px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      outline: none;
      font-size: 16px;
      background: var(--card2);
      color: var(--text);
    }

    button{
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--btnBorder);
      background: var(--btn);
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity: .55; cursor: not-allowed; transform:none; }

    .pill{
      display:inline-block;
      padding: 3px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      background: var(--card2);
      white-space: nowrap;
    }

    /* ===== Lists ===== */
    .list{ margin-top: 12px; display:grid; gap: 10px; }

    .item{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 10px;
      background: var(--card2);
      user-select: none;
      touch-action: none;
      position: relative;
    }
    .item.dragging{
      opacity: .78;
      transform: scale(0.995);
      box-shadow: var(--shadow);
    }
    .item.drop-target{
      outline: 2px dashed var(--outline);
      outline-offset: 2px;
    }

    .leftWrap{ display:flex; align-items:center; gap: 10px; min-width: 0; }

    .handle{
      width: 34px;
      min-width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 16px;
      color: var(--muted);
    }

    .nameText{
      font-size: 16px;
      font-weight: 650;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 62vw;
    }

    /* ===== Dots menu ===== */
    .menuBtn{
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      color: var(--muted);
      padding: 0;
    }

    .menu{
      position: absolute;
      right: 10px;
      top: 52px;
      min-width: 160px;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: none;
      z-index: 30;
    }
    .menu.open{ display:block; }
    .menuItem{
      width: 100%;
      border: none;
      background: transparent;
      padding: 12px 12px;
      text-align: left;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
    }
    .menuItem:hover{ background: var(--menuHover); }
    .menuItem.danger{ color: var(--danger); }

    /* ===== Wheel ===== */
    .spinAllWrap{ display:flex; justify-content:center; margin-bottom: 10px; }
    .spinTopRow{ display:flex; gap: 10px; flex-wrap: wrap; justify-content:center; width: 100%; }
    .spinAllBtn{
      min-width: 160px;
      padding: 12px 18px;
      font-weight: 800;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--btn);
      color: var(--text);
    }
    .spinTopBtn{ padding: 12px 14px; font-weight: 750; border-radius: 14px; }

    .wheelGrid{
      display:grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 260px));
      justify-content: center;
      margin: 0 auto;
      max-width: 900px;
    }

    .slotCol{ display:flex; flex-direction:column; gap: 10px; width: 100%; }
    .slotTitle{ text-align:center; }

    .slot{
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--card2);
      padding: 16px;
      min-height: 72px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
      text-align:center;
      user-select: none;
    }
    .slot.clickable{ cursor: pointer; }

    .slotControls{ display:flex; gap: 8px; width: 100%; }
    .miniBtn{
      flex: 1 1 auto;
      padding: 10px 10px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 750;
      border: 1px solid var(--border);
      background: var(--btn);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 6px;
      min-height: 44px;
    }

    .gripBtn{
      width: 100%;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--btn);
      padding: 12px 14px;
      font-weight: 800;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      min-height: 48px;
    }
    .gripBtn .mutedSmall{ font-weight: 700; color: var(--muted); font-size: 13px; }
    .gripBtn.on{ border-color: rgba(255,90,82,0.35); background: rgba(255,90,82,0.10); }
    [data-theme="dark"] .gripBtn.on{ border-color: rgba(255,90,82,0.40); background: rgba(255,90,82,0.12); }

    .comboBig{
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: var(--card);
      font-size: 26px;
      font-weight: 900;
      text-align: center;
      letter-spacing: .2px;
    }

    /* ===== Bottom tabs ===== */
    .tabs{
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      border-top: 1px solid var(--border);
      background: var(--card);
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 1fr;
      z-index: 20;
    }
    .tabBtn{
      border: none;
      background: transparent;
      padding: 12px 8px 14px;
      cursor: pointer;
      font-size: 12px;
      color: var(--muted);
    }
    .tabBtn strong{ display:block; font-size: 12px; color: var(--text); }
    .tabBtn.active{ background: var(--tabActive); }

    .headerRow{ display:flex; align-items:flex-start; justify-content: space-between; gap: 10px; }
    .tinyBtn{ padding: 10px 10px; font-size: 13px; }

    /* ===== Settings modal ===== */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 14px;
    }
    .overlay.open{ display:flex; }

    .modal{
      width: 100%;
      max-width: 760px;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;

      height: min(78vh, 700px);

      display:flex;
      flex-direction: column;
    }
    .modalHeader{
      padding: 12px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex: 0 0 auto;
    }

    .segTabs{
      margin: 10px 12px 0;
      border: 1px solid var(--border);
      background: var(--card2);
      border-radius: 14px;
      overflow: hidden;
      display:grid;
      grid-auto-flow: column;
      grid-auto-columns: 1fr;
      flex: 0 0 auto;
    }
    .segTabBtn{
      border: none;
      background: transparent;
      padding: 10px 10px;
      font-weight: 900;
      font-size: 13px;
      color: var(--muted);
      cursor: pointer;
    }
    .segTabBtn.active{
      background: var(--tabActive);
      color: var(--text);
    }

    .modalBody{
      padding: 12px;
      overflow: auto;
      flex: 1 1 auto;
    }
    .modalFooter{
      padding: 12px;
      border-top: 1px solid var(--border);
      display:flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
      flex: 0 0 auto;
      background: var(--card);
    }

    .settingsPanel{ display:none; }
    .settingsPanel.active{ display:block; }

    .visList{ display:grid; gap: 10px; }
    .visRow{
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--card2);
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .visName{
      font-weight: 750;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .switch{ position: relative; width: 58px; height: 34px; flex: 0 0 auto; }
    .switch input{ opacity: 0; width: 0; height: 0; position: absolute; }
    .slider{
      position:absolute;
      inset:0;
      background: var(--accent);
      border: 1px solid var(--border);
      border-radius: 999px;
      transition: .15s ease;
    }
    .slider::before{
      content:"";
      position:absolute;
      height: 26px;
      width: 26px;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 999px;
      transition: .15s ease;
      box-shadow: 0 6px 14px rgba(0,0,0,0.10);
    }
    .switch input:checked + .slider{
      background: rgba(34,197,94,0.18);
      border-color: rgba(34,197,94,0.35);
    }
    [data-theme="dark"] .switch input:checked + .slider{
      background: rgba(34,197,94,0.22);
      border-color: rgba(34,197,94,0.45);
    }
    .switch input:checked + .slider::before{
      transform: translateY(-50%) translateX(24px);
    }

    .visBadge{
      font-size: 12px;
      color: var(--muted);
      background: var(--card);
      border: 1px solid var(--border);
      padding: 4px 10px;
      border-radius: 999px;
      min-width: 86px;
      text-align:center;
    }

    /* Toast (keep only for import) */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 84px;
      padding: 10px 12px;
      border-radius: 14px;
      background: var(--toastBg);
      color: var(--toastText);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 13px;
      font-weight: 700;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 80;
      max-width: calc(100vw - 28px);
      text-align:center;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    @media (max-width: 680px){
      .wheelGrid{
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        justify-content: stretch;
        max-width: 100%;
      }
      .slotCol{ width: auto; gap: 8px; min-width: 0; }
      .slot{ padding: 10px; min-height: 56px; font-size: 16px; }
      .slotTitle{ font-size: 12px; }
      .slotControls{ flex-direction: column; gap: 6px; }
      .miniBtn{ width: 100%; min-height: 38px; padding: 8px 8px; font-size: 12px; }
      .gripBtn{ min-height: 40px; padding: 10px 10px; font-size: 13px; }
      .toast{ bottom: 92px; }
      .modal{ height: min(82vh, 720px); }
    }
  </style>
</head>

<body>
  <header>
    <div class="headerRow">
      <div>
        <h1 id="title">Names</h1>
        <div class="muted" id="subtitle">Press Spin on the wheel. Toggle section visibility in settings. Autosaves.</div>
      </div>
      <div class="row" style="justify-content:flex-end;">
        <button class="tinyBtn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
        <button class="tinyBtn" id="themeToggle" title="Theme: Light ‚Üî Dark">üåì</button>
      </div>
    </div>
  </header>

  <main id="main"></main>

  <nav class="tabs" id="tabs" aria-label="Bottom tabs"></nav>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Settings Modal -->
  <div class="overlay" id="settingsOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Settings">
      <div class="modalHeader">
        <strong>Settings</strong>
        <button id="closeSettings" class="tinyBtn" type="button">‚úï</button>
      </div>

      <div class="segTabs" role="tablist" aria-label="Settings tabs">
        <button class="segTabBtn" id="settingsTab-visibility" type="button">Visibility</button>
        <button class="segTabBtn" id="settingsTab-transfer" type="button">Import/Export</button>
      </div>

      <div class="modalBody">
        <div id="settingsPanel-visibility" class="settingsPanel">
          <div class="muted">Toggle sections on/off. (Off = hidden from tabs + wheel)</div>
          <div id="sectionSettings" class="visList" style="margin-top:10px;"></div>
        </div>

        <div id="settingsPanel-transfer" class="settingsPanel">
          <div class="card" style="padding:12px;">
            <div class="row" style="justify-content:flex-start;">
              <button id="exportCsvBtn" type="button">Export CSV</button>
              <button id="importBtn" type="button">Import CSV</button>
              <span class="pill">CSV</span>
            </div>
            <input id="importFile" type="file" accept=".csv" style="display:none;" />
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <button id="saveSettings" type="button">Done</button>
      </div>
    </div>
  </div>

  <script>
    const KEY = "name_slot_app_v11_only_import_toast";
    const state = JSON.parse(localStorage.getItem(KEY) || "{}");

    let themeMode = (state.themeMode === "light" || state.themeMode === "dark") ? state.themeMode : "dark";

    function makeId() {
      return "sec_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function normalizeInput(s) { return (s || "").trim().replace(/\s+/g, " "); }

    function migrateSections(oldState){
      if (Array.isArray(oldState.sections)) {
        return oldState.sections
          .filter(s => s && typeof s === "object")
          .map(s => ({
            id: String(s.id || makeId()),
            label: normalizeInput(String(s.label ?? "Section")) || "Section",
            enabled: (typeof s.enabled === "boolean") ? s.enabled : true,
            items: Array.isArray(s.items) ? s.items : []
          }));
      }

      const firstNames  = Array.isArray(oldState.firstNames) ? oldState.firstNames : [];
      const middleNames = Array.isArray(oldState.middleNames) ? oldState.middleNames : [];
      const lastNames   = Array.isArray(oldState.lastNames) ? oldState.lastNames : [];

      return [
        { id: "first",  label: "First",  enabled: true, items: firstNames },
        { id: "middle", label: "Middle", enabled: true, items: middleNames },
        { id: "last",   label: "Last",   enabled: true, items: lastNames },
      ];
    }

    let sections = migrateSections(state);
    let favorites = Array.isArray(state.favorites) ? state.favorites : [];

    const wheelStateFromStorage = (state.wheelState && typeof state.wheelState === "object") ? state.wheelState : {};
    const current = (wheelStateFromStorage.current && typeof wheelStateFromStorage.current === "object") ? wheelStateFromStorage.current : {};
    const grip = (wheelStateFromStorage.grip && typeof wheelStateFromStorage.grip === "object") ? wheelStateFromStorage.grip : {};

    sections.forEach(s => { if (!(s.id in current)) current[s.id] = ""; });
    sections.forEach(s => { if (!(s.id in grip)) grip[s.id] = false; });

    function save() {
      localStorage.setItem(KEY, JSON.stringify({
        themeMode,
        sections,
        favorites,
        wheelState: { current, grip }
      }));
    }

    const $ = (id) => document.getElementById(id);
    const title = $("title");
    const subtitle = $("subtitle");

    function applyTheme() {
      document.documentElement.setAttribute("data-theme", themeMode);
      save();
    }
    function toggleTheme() {
      themeMode = (themeMode === "dark") ? "light" : "dark";
      applyTheme();
    }

    function pickRandomDifferent(arr, currentValue) {
      if (!arr.length) return "";
      if (arr.length === 1) return arr[0];
      const cur = (currentValue || "").toLowerCase();
      const filtered = arr.filter(x => String(x).toLowerCase() !== cur);
      const pool = filtered.length ? filtered : arr;
      return pool[Math.floor(Math.random() * pool.length)];
    }

    // Toast (IMPORT ONLY)
    let toastTimer = null;
    function showImportToast(){
      const el = $("toast");
      if (!el) return;
      el.textContent = "Imported ‚úÖ";
      el.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.classList.remove("show"), 1600);
    }

    // Menus
    let openMenuEl = null;
    function closeOpenMenu() {
      if (openMenuEl) { openMenuEl.classList.remove("open"); openMenuEl = null; }
    }
    document.addEventListener("pointerdown", (e) => {
      const insideMenu = e.target.closest(".menu") || e.target.closest(".menuBtn");
      if (!insideMenu) closeOpenMenu();
    });

    // Drag reorder
    function attachReorderHandlers(containerEl, listRef) {
      let draggingIdx = null;
      let overIdx = null;

      containerEl.addEventListener("pointerdown", (e) => {
        const itemEl = e.target.closest(".item");
        if (!itemEl) return;
        const handle = e.target.closest(".handle");
        if (!handle) return;

        closeOpenMenu();
        draggingIdx = Number(itemEl.dataset.index);
        itemEl.classList.add("dragging");
        itemEl.setPointerCapture(e.pointerId);
      });

      containerEl.addEventListener("pointermove", (e) => {
        if (draggingIdx === null) return;
        const el = document.elementFromPoint(e.clientX, e.clientY);
        const overItem = el ? el.closest(".item") : null;

        containerEl.querySelectorAll(".item").forEach(x => x.classList.remove("drop-target"));

        if (overItem && overItem.parentElement === containerEl) {
          overIdx = Number(overItem.dataset.index);
          if (!Number.isNaN(overIdx) && overIdx !== draggingIdx) overItem.classList.add("drop-target");
        } else {
          overIdx = null;
        }
      });

      containerEl.addEventListener("pointerup", () => {
        const draggingEl = containerEl.querySelector(".item.dragging");
        if (draggingEl) draggingEl.classList.remove("dragging");
        containerEl.querySelectorAll(".item").forEach(x => x.classList.remove("drop-target"));

        if (draggingIdx !== null && overIdx !== null && overIdx !== draggingIdx) {
          const item = listRef.splice(draggingIdx, 1)[0];
          listRef.splice(overIdx, 0, item);
          save();
          renderAll();
        }
        draggingIdx = null;
        overIdx = null;
      });

      containerEl.addEventListener("pointercancel", () => {
        containerEl.querySelectorAll(".item").forEach(x => { x.classList.remove("dragging"); x.classList.remove("drop-target"); });
        draggingIdx = null;
        overIdx = null;
      });
    }

    // List render
    function promptEdit(oldValue) {
      const next = normalizeInput(prompt("Edit item:", oldValue) || "");
      return next ? next : null;
    }

    function renderList(containerEl, items, onEdit, onDelete) {
      containerEl.innerHTML = "";

      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.style.padding = "10px 2px";
        empty.textContent = "No items yet. Add one above.";
        containerEl.appendChild(empty);
        return;
      }

      items.forEach((name, idx) => {
        const row = document.createElement("div");
        row.className = "item";
        row.dataset.index = String(idx);

        const left = document.createElement("div");
        left.className = "leftWrap";

        const handle = document.createElement("div");
        handle.className = "handle";
        handle.title = "Drag to reorder";
        handle.textContent = "‚â°";

        const text = document.createElement("div");
        text.className = "nameText";
        text.textContent = name;

        left.appendChild(handle);
        left.appendChild(text);

        const menuBtn = document.createElement("button");
        menuBtn.className = "menuBtn";
        menuBtn.title = "Options";
        menuBtn.type = "button";
        menuBtn.textContent = "‚ãÆ";

        const menu = document.createElement("div");
        menu.className = "menu";

        const edit = document.createElement("button");
        edit.className = "menuItem";
        edit.type = "button";
        edit.textContent = "Edit";
        edit.onclick = () => { closeOpenMenu(); onEdit(idx); };

        const del = document.createElement("button");
        del.className = "menuItem danger";
        del.type = "button";
        del.textContent = "Delete";
        del.onclick = () => { closeOpenMenu(); onDelete(idx); };

        menu.appendChild(edit);
        menu.appendChild(del);

        menuBtn.onclick = (e) => {
          e.stopPropagation();
          if (openMenuEl && openMenuEl !== menu) closeOpenMenu();
          const willOpen = !menu.classList.contains("open");
          closeOpenMenu();
          if (willOpen) { menu.classList.add("open"); openMenuEl = menu; }
        };

        row.appendChild(left);
        row.appendChild(menuBtn);
        row.appendChild(menu);
        containerEl.appendChild(row);
      });
    }

    // Favorites
    function renderFavs(containerEl) {
      containerEl.innerHTML = "";

      if (!favorites.length) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.style.padding = "10px 2px";
        empty.textContent = "No favorites yet.";
        containerEl.appendChild(empty);
        return;
      }

      favorites.forEach((name, idx) => {
        const row = document.createElement("div");
        row.className = "item";
        row.dataset.index = String(idx);

        const left = document.createElement("div");
        left.className = "leftWrap";

        const handle = document.createElement("div");
        handle.className = "handle";
        handle.title = "Drag to reorder";
        handle.textContent = "‚â°";

        const text = document.createElement("div");
        text.className = "nameText";
        text.textContent = name;

        left.appendChild(handle);
        left.appendChild(text);

        const menuBtn = document.createElement("button");
        menuBtn.className = "menuBtn";
        menuBtn.title = "Options";
        menuBtn.type = "button";
        menuBtn.textContent = "‚ãÆ";

        const menu = document.createElement("div");
        menu.className = "menu";

        const del = document.createElement("button");
        del.className = "menuItem danger";
        del.type = "button";
        del.textContent = "Delete";
        del.onclick = () => {
          closeOpenMenu();
          favorites.splice(idx, 1);
          save();
          renderAll();
        };

        menu.appendChild(del);

        menuBtn.onclick = (e) => {
          e.stopPropagation();
          if (openMenuEl && openMenuEl !== menu) closeOpenMenu();
          const willOpen = !menu.classList.contains("open");
          closeOpenMenu();
          if (willOpen) { menu.classList.add("open"); openMenuEl = menu; }
        };

        row.appendChild(left);
        row.appendChild(menuBtn);
        row.appendChild(menu);
        containerEl.appendChild(row);
      });
    }

    function enabledSections() { return sections.filter(s => s.enabled); }

    // UI building
    const panelsByTab = {};
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildPanels() {
      const main = $("main");
      main.innerHTML = "";
      for (const k in panelsByTab) delete panelsByTab[k];

      enabledSections().forEach(sec => {
        const panel = document.createElement("section");
        panel.className = "panel";
        panel.id = `panel-${sec.id}`;
        panel.innerHTML = `
          <div class="card">
            <div class="row">
              <input id="input-${sec.id}" type="text" placeholder="Add an item‚Ä¶" autocomplete="off" />
              <button id="add-${sec.id}">Add</button>
              <span class="pill" id="count-${sec.id}">0</span>
            </div>
            <div class="list" id="list-${sec.id}"></div>
          </div>
        `;
        main.appendChild(panel);
        panelsByTab[sec.id] = panel;
      });

      const wheel = document.createElement("section");
      wheel.className = "panel";
      wheel.id = "panel-wheel";
      wheel.innerHTML = `
        <div class="card">
          <div class="spinAllWrap">
            <div class="spinTopRow">
              <button id="spin-all" class="spinAllBtn">üé≤ Spin</button>
              <button id="clear-all" class="spinTopBtn" title="Clear current wheel values">üßπ Clear all</button>
              <button id="save-fav-top" class="spinTopBtn" title="Save current combo to favorites">‚≠ê Favorite</button>
            </div>
          </div>

          <div class="row" style="justify-content:center; margin-bottom:12px;">
            <span class="pill" id="counts-pill">Items: 0 ‚Ä¢ Combos: 0</span>
          </div>

          <div class="wheelGrid" id="wheelGrid"></div>

          <div class="comboBig" id="combo-text">‚Äî</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="row" style="justify-content:space-between;">
            <strong>Favorites</strong>
            <span class="pill" id="count-favs">0</span>
          </div>
          <div class="list" id="list-favs"></div>
        </div>
      `;
      main.appendChild(wheel);
      panelsByTab["wheel"] = wheel;
    }

    function buildTabs() {
      const tabs = $("tabs");
      tabs.innerHTML = "";

      const defs = [];
      enabledSections().forEach(sec => defs.push({ key: sec.id, text: sec.label }));
      defs.push({ key: "wheel", text: "Slot Wheel" });

      defs.forEach(def => {
        const btn = document.createElement("button");
        btn.className = "tabBtn";
        btn.dataset.tab = def.key;
        btn.innerHTML = `<strong>${escapeHtml(def.text)}</strong>`;
        btn.addEventListener("click", () => setTab(def.key));
        tabs.appendChild(btn);
      });

      if (currentTab !== "wheel") {
        const ok = enabledSections().some(s => s.id === currentTab);
        if (!ok) currentTab = "wheel";
      }
      setTab(currentTab);
    }

    let currentTab = "wheel";
    function setTab(tab) {
      closeOpenMenu();
      currentTab = tab;

      Object.values(panelsByTab).forEach(p => p.classList.remove("active"));
      if (panelsByTab[tab]) panelsByTab[tab].classList.add("active");

      document.querySelectorAll(".tabBtn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });

      const sec = sections.find(s => s.id === tab);
      if (sec) {
        title.textContent = sec.label;
        subtitle.textContent = "Add items one at a time. Drag by ‚â° to reorder. Tap ‚ãÆ for options. Autosaves.";
      } else {
        title.textContent = "Slot Wheel";
        subtitle.textContent = "Press Spin. Grip freezes a section. Use small Spin/Clear under each slot. Autosaves.";
      }
    }

    // Wheel
    function updateCounts() {
      enabledSections().forEach(sec => {
        const el = document.getElementById(`count-${sec.id}`);
        if (el) el.textContent = sec.items.length;
      });

      const enabled = enabledSections();
      const lengths = enabled.map(s => s.items.length);
      const combos = enabled.length ? lengths.reduce((acc, n) => acc * n, 1) : 0;

      const itemsPart = enabled.length ? lengths.join(" ‚Ä¢ ") : "0";
      const pill = document.getElementById("counts-pill");
      if (pill) pill.textContent = `Items: ${itemsPart} ‚Ä¢ Combos: ${combos || 0}`;

      const favCount = document.getElementById("count-favs");
      if (favCount) favCount.textContent = favorites.length;
    }

    function updateGripUI(secId){
      const btn = document.getElementById(`grip-${secId}`);
      if (!btn) return;
      const on = !!grip[secId];
      btn.classList.toggle("on", on);
      btn.innerHTML = on
        ? `üß≤ <span>Grip</span> <span class="mutedSmall">(on)</span>`
        : `üß≤ <span>Grip</span>`;
      btn.setAttribute("aria-pressed", on ? "true" : "false");

      const miniSpin = document.getElementById(`mini-spin-${secId}`);
      if (miniSpin) {
        miniSpin.disabled = on;
        miniSpin.title = on ? "Ungrip to spin this section" : "Spin this section";
      }
    }

    function updateCombo() {
      const enabled = enabledSections();

      enabled.forEach(s => {
        const slotEl = document.getElementById(`slot-${s.id}`);
        if (slotEl) slotEl.textContent = current[s.id] || "‚Äî";
        updateGripUI(s.id);
      });

      const parts = enabled.map(s => current[s.id]).filter(Boolean);
      const comboEl = document.getElementById("combo-text");
      if (comboEl) comboEl.textContent = parts.length ? parts.join(" ") : "‚Äî";

      save();
    }

    function spinSection(secId){
      const sec = enabledSections().find(s => s.id === secId);
      if (!sec) return;
      if (grip[secId]) return;
      current[secId] = pickRandomDifferent(sec.items, current[secId]);
      updateCombo();
    }

    function clearSection(secId){
      if (!(secId in current)) return;
      current[secId] = "";
      updateCombo();
    }

    function spinAll() {
      enabledSections().forEach(sec => {
        if (grip[sec.id]) return;
        current[sec.id] = pickRandomDifferent(sec.items, current[sec.id]);
      });
      updateCombo();
    }

    function clearAll(){
      enabledSections().forEach(sec => { current[sec.id] = ""; });
      updateCombo();
    }

    function toggleGrip(secId){
      grip[secId] = !grip[secId];
      updateGripUI(secId);
      save();
    }

    function saveFavoriteFromTop(){
      const combo = document.getElementById("combo-text")?.textContent;
      if (!combo || combo === "‚Äî") return;
      if (!favorites.includes(combo)) favorites.unshift(combo);
      save();
      renderAll();
    }

    function renderWheel() {
      const grid = document.getElementById("wheelGrid");
      if (!grid) return;
      grid.innerHTML = "";

      const enabled = enabledSections();
      enabled.forEach(sec => {
        const col = document.createElement("div");
        col.className = "slotCol";
        col.innerHTML = `
          <div class="slotTitle"><strong>${escapeHtml(sec.label)}</strong></div>
          <div class="slot clickable" id="slot-${sec.id}" title="Click to spin this section">‚Äî</div>

          <div class="slotControls">
            <button class="miniBtn" id="mini-spin-${sec.id}" type="button">üé≤ Spin</button>
            <button class="miniBtn" id="mini-clear-${sec.id}" type="button">üßπ Clear</button>
          </div>

          <button class="gripBtn" id="grip-${sec.id}" type="button" aria-pressed="false">üß≤ Grip</button>
        `;
        grid.appendChild(col);

        const slotEl = col.querySelector(`#slot-${CSS.escape(sec.id)}`);
        const gripBtn = col.querySelector(`#grip-${CSS.escape(sec.id)}`);
        const miniSpin = col.querySelector(`#mini-spin-${CSS.escape(sec.id)}`);
        const miniClear = col.querySelector(`#mini-clear-${CSS.escape(sec.id)}`);

        if (slotEl) slotEl.onclick = () => spinSection(sec.id);
        if (miniSpin) miniSpin.onclick = () => spinSection(sec.id);
        if (miniClear) miniClear.onclick = () => clearSection(sec.id);
        if (gripBtn) gripBtn.onclick = () => toggleGrip(sec.id);
      });

      const spinBtn = document.getElementById("spin-all");
      if (spinBtn) spinBtn.onclick = spinAll;

      const clearBtn = document.getElementById("clear-all");
      if (clearBtn) clearBtn.onclick = clearAll;

      const favTop = document.getElementById("save-fav-top");
      if (favTop) favTop.onclick = saveFavoriteFromTop;
    }

    // Add item
    function addToSection(secId) {
      const sec = sections.find(s => s.id === secId);
      const input = document.getElementById(`input-${secId}`);
      if (!sec || !input) return;

      const v = normalizeInput(input.value);
      if (!v) return;

      const exists = sec.items.some(x => String(x).toLowerCase() === v.toLowerCase());
      if (!exists) sec.items.unshift(v);

      input.value = "";
      save();
      renderAll();
    }

    // CSV export/import
    function downloadFile(filename, content, mime) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportCSV() {
      const cols = sections.map(s => s.label);
      cols.push("Favorites");

      const maxLen = Math.max(
        0,
        ...sections.map(s => (s.items || []).length),
        (favorites || []).length
      );

      const rows = [];
      rows.push(cols);

      for (let i = 0; i < maxLen; i++) {
        const row = [];
        sections.forEach(sec => row.push((sec.items && sec.items[i]) ? String(sec.items[i]) : ""));
        row.push((favorites && favorites[i]) ? String(favorites[i]) : "");
        rows.push(row);
      }

      const esc = (s) => {
        const str = String(s ?? "");
        if (/[",\n\r]/.test(str)) return `"${str.replaceAll('"', '""')}"`;
        return str;
      };

      const csv = rows.map(r => r.map(esc).join(",")).join("\n");
      downloadFile("name-slot-export.csv", csv, "text/csv");
      // no toast for export
    }

    function importFromCSV(raw){
      const lines = String(raw || "").split(/\r?\n/).filter(line => line.trim().length);
      if (!lines.length) return false;

      const parseCSVLine = (line) => {
        const out = [];
        let cur = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
            else inQuotes = !inQuotes;
          } else if (ch === "," && !inQuotes) {
            out.push(cur);
            cur = "";
          } else {
            cur += ch;
          }
        }
        out.push(cur);
        return out.map(s => s.trim());
      };

      const header = parseCSVLine(lines[0]).map(h => normalizeInput(h));
      if (!header.length) return false;

      sections.forEach(sec => sec.items = []);
      favorites = [];

      const colTargets = header.map(colName => {
        if (!colName) return { type: "ignore" };
        if (colName.toLowerCase() === "favorites") return { type: "favorites" };
        const sec = sections.find(s => s.label.toLowerCase() === colName.toLowerCase());
        if (sec) return { type: "section", id: sec.id };
        return { type: "ignore" };
      });

      for (let i = 1; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        for (let c = 0; c < colTargets.length; c++) {
          const t = colTargets[c];
          const v = normalizeInput(cols[c] ?? "");
          if (!v) continue;

          if (t.type === "favorites") {
            if (!favorites.includes(v)) favorites.push(v);
          } else if (t.type === "section") {
            const sec = sections.find(s => s.id === t.id);
            if (!sec) continue;
            const exists = sec.items.some(x => String(x).toLowerCase() === v.toLowerCase());
            if (!exists) sec.items.push(v);
          }
        }
      }

      save();
      renderAll();
      setTab("wheel");
      showImportToast();
      return true;
    }

    // Render all
    function renderAll() {
      sections.forEach(s => { if (!(s.id in current)) current[s.id] = ""; });
      sections.forEach(s => { if (!(s.id in grip)) grip[s.id] = false; });

      buildPanels();
      buildTabs();
      renderWheel();

      enabledSections().forEach(sec => {
        const listEl = document.getElementById(`list-${sec.id}`);
        const addBtn = document.getElementById(`add-${sec.id}`);
        const inputEl = document.getElementById(`input-${sec.id}`);

        if (addBtn) addBtn.onclick = () => addToSection(sec.id);
        if (inputEl) {
          inputEl.placeholder = `Add a ${sec.label.toLowerCase()}‚Ä¶`;
          inputEl.onkeydown = (e) => {
            if (e.key === "Enter") { e.preventDefault(); addToSection(sec.id); }
          };
        }

        if (listEl) {
          renderList(listEl, sec.items,
            (i) => {
              const v = promptEdit(sec.items[i]);
              if (v) { sec.items[i] = v; save(); renderAll(); }
            },
            (i) => { sec.items.splice(i, 1); save(); renderAll(); }
          );
          attachReorderHandlers(listEl, sec.items);
        }
      });

      const favList = document.getElementById("list-favs");
      if (favList) {
        renderFavs(favList);
        attachReorderHandlers(favList, favorites);
      }

      updateCounts();
      updateCombo();
    }

    // Settings modal
    const overlay = $("settingsOverlay");
    const settingsBtn = $("settingsBtn");
    const closeSettingsBtn = $("closeSettings");

    function openSettings(){
      renderSettingsUI();
      setSettingsTab(settingsTab);
      overlay.classList.add("open");
      overlay.setAttribute("aria-hidden","false");
    }
    function closeSettings(){
      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden","true");
    }
    settingsBtn.onclick = openSettings;
    closeSettingsBtn.onclick = closeSettings;
    overlay.addEventListener("pointerdown", (e) => {
      if (e.target === overlay) closeSettings();
    });

    function renderSettingsUI(){
      const wrap = $("sectionSettings");
      wrap.innerHTML = "";

      sections.forEach(sec => {
        const row = document.createElement("div");
        row.className = "visRow";

        const enabledId = `sec-enabled-${sec.id}`;

        row.innerHTML = `
          <div style="min-width:0; display:grid; gap:6px;">
            <div class="visName">${escapeHtml(sec.label)}</div>
            <div class="muted" style="font-size:12px;">${sec.enabled ? "Visible" : "Hidden"}</div>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <div class="visBadge" id="badge-${sec.id}">${sec.enabled ? "ON" : "OFF"}</div>
            <label class="switch" title="Visibility">
              <input id="${enabledId}" type="checkbox" ${sec.enabled ? "checked":""} />
              <span class="slider"></span>
            </label>
          </div>
        `;
        wrap.appendChild(row);

        const cb = row.querySelector(`#${CSS.escape(enabledId)}`);
        const badge = row.querySelector(`#badge-${CSS.escape(sec.id)}`);
        const mutedLine = row.querySelector(".muted");
        cb.addEventListener("change", () => {
          badge.textContent = cb.checked ? "ON" : "OFF";
          mutedLine.textContent = cb.checked ? "Visible" : "Hidden";
        });
      });
    }

    let settingsTab = "visibility";
    function setSettingsTab(tab){
      settingsTab = tab;

      $("settingsTab-visibility").classList.toggle("active", tab === "visibility");
      $("settingsTab-transfer").classList.toggle("active", tab === "transfer");

      $("settingsPanel-visibility").classList.toggle("active", tab === "visibility");
      $("settingsPanel-transfer").classList.toggle("active", tab === "transfer");
    }

    $("settingsTab-visibility").onclick = () => setSettingsTab("visibility");
    $("settingsTab-transfer").onclick = () => setSettingsTab("transfer");

    $("saveSettings").onclick = () => {
      sections = sections.map(sec => {
        const enabledEl = document.getElementById(`sec-enabled-${sec.id}`);
        const nextEnabled = !!(enabledEl && enabledEl.checked);
        return { ...sec, enabled: nextEnabled };
      });

      save();
      closeSettings();
      renderAll();

      if (currentTab !== "wheel") {
        const ok = enabledSections().some(s => s.id === currentTab);
        if (!ok) setTab("wheel");
      }
      // no toast on Done
    };

    // Transfer buttons
    $("exportCsvBtn").onclick = () => exportCSV();

    $("importBtn").onclick = () => {
      const input = $("importFile");
      input.value = "";
      input.click();
    };

    $("importFile").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        const ok = importFromCSV(String(reader.result || ""));
        if (!ok) {
          // keep it simple; no toast spam
          alert("Import failed. Please choose a valid CSV export from this app.");
        }
      };
      reader.readAsText(file);
    });

    // Init
    $("themeToggle").onclick = toggleTheme;

    applyTheme();
    renderAll();
    setTab(enabledSections()[0]?.id || "wheel");
  </script>
</body>
</html>
